# Ресторан

## Перемещение блюд (смена статуса)

Приложение для терминалов ресторана. 

Проект делал не я. Моя задача была - настроить перемещение карточек по "столу" https://prnt.sc/10sqvxx по этому полю, меняя значение статуса блюда. 
Внешне вёрсткой всё было настроено, как на скрине, а "внутри" эти блюда - товары заказов со своими свойствами.

## Как настроено

Создаем список заказов компонентом sale.personal.order.list в нём выводим заказы и блюда в этих заказах. Т.к. всё будет происходить без перезагрузок - тело шаблона оборачиваем в RestartBuffer и добавляем атрибутов для передачи в обработчик https://prnt.sc/10sr7u4 /ajax/setDishState.php. 

Вешаем на событие перемещения карточки отправку данных в обработчик https://prnt.sc/10sr9ta. В обработчике подключаем всё, что нам может понадобится и ловим прилетающие значения https://prnt.sc/10sreaa. Расписываем для ответа все данные, чтобы перезаполнить корректно карточку блюда в новом столбце и находим наше блюдо в заказе https://prnt.sc/10srj3c и меняем ему статус и время (точнее свойства со значениями этих параметров), если блюдо попало в последний столбец "Приготовлено" https://prnt.sc/10srmsa, а теги опять же для вывода в карточке. В конце обработчика донастраиваем время https://prnt.sc/10srpl6 т.к. таймер начинает новый отсчёт с перемещением.

### Мгновенное обновление на всех устройствах

А для мгновенного обновления "стола" с блюдами на всех устройствах без ежесекундных перезагрузок страницы - пользуем push&pull от битрикса. В ините вешаем на событие сохранения заказа нашу функцию https://prnt.sc/10srw8c которая кидает событие в стек https://prnt.sc/10srx00 с нужными параметрами, по которым мы уже у себя отслеживаем и обновляем наше окно https://prnt.sc/10sry2k, скрывая битровый лоадер.

## Добавление произвольной скидки при оплате

Также необходимо было настроить добавление к заказу произвольной скидки или наценки в виде чаевых при оплате заказа.

В поле ввода добавлялся тип наценка/скидка и значение, скриптом отправлялась в обработчик /ajax/addDiscountOrder.php где уже поределялся тип, и по наличию значка процента "%" его значение в процентном соотношении или целочисленном, создавалось правило с условиями для конкретного заказа и пользователя, создавался купон и тут же применялся для заказа. При удалении же скидки/наценки - применение купона отменялось.

И заказ тут же пересчитывался.